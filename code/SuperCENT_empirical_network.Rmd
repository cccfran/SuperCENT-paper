---
title: "Four empirical networks"
author: "Junhui Cai, Dan Yang, Wu Zhu, Haipeng Shen, Linda Zhao"
output:
  pdf_document:
    number_sections: yes
  html_document:
    df_print: paged
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
urlcolor: blue
---

```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(data.table, matrixStats, dplyr, ggplot2, igraph,
               latex2exp, tidyverse, 
               irlba, xtable, stargazer, circlize, kableExtra)
pacman::p_load(data.table, matrixStats, dplyr, ggplot2, ggpubr,
               grid, gridExtra, gtable, latex2exp, facetscales)

source("utils_sim.R")

fig_width <- 12
fig_height <- 6

knitr::opts_chunk$set(echo = F, fig.height = fig_height, fig.width = fig_width)
output_type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
if(is.null(output_type)) output_type <- "latex"

yr <- 2013
dmax <- 20
```

In this report, we show that many (economic) networks are, in fact, low-rank and each of their leading singular value dominates the non-leading ones. Specifically, we examine the spectral properties of four empirical networks: (A) global trade network, (B) innovation network, (C) production network, and (D) equity network. We will first describe each network and show the top 20 singular values of each network in 2013.

To reproduce this report, `Knit` this file in RStudio.
One can set `echo = T` for the each chunk or globally `knitr::opts_chunk$set(echo = T)` to show the code in the report.

# Data

* `data_empirical_network/trade_data_sub.csv`: Trade network
* `data_empirical_network/naics3_uspc_naics3_W_matrix.csv`: Innovation network
* `data_empirical_network/IO_naics3_1997_2018_naics07.xlsx`: Production network
* `data_empirical_network/equity_network_svd.csv`: Equity network is proprietary data but we provide the top 50 singular values

\pagebreak
## Trade network

The global trade network is the country-level trade network. We include all 35 countries here in the bilateral trade data from the correlates of war project (COW). The trade network is defined as the proportion of imports from other countries, i.e., the proportion of imports from country i among all the imports of country j. 

```{r}
trade_raw <- fread("../data_empirical_network/trade_data_sub.csv")
```

```{r}
trade <- trade_raw[year %in% yr]

trade_g <- graph_from_data_frame(trade)
trade_mat <- as_adjacency_matrix(trade_g, attr = "value")
trade_mat <- sweep(trade_mat, 2, colSums(trade_mat), "/")

trade_svd <- svd(trade_mat)

p_trade <- data.frame(d = trade_svd$d[1:dmax]) %>%
  ggplot(aes(x = 1:dmax, y = d^2)) + 
  geom_point() +
  theme_bw() +
  xlab("Number of components" ) + 
  ylab(TeX(paste0("Top ", dmax, " squared singular values"))) +
  ggtitle("Trade network") +
  my_theme

p_trade
```


Similarly we define the trade network as the import-export amount in US dollars or as the proportion of exports to other countries. The results are similar.

```{r}
trade <- trade_raw[year %in% yr]

trade_g <- graph_from_data_frame(trade)
trade_mat <- as_adjacency_matrix(trade_g, attr = "value")

trade_svd <- svd(trade_mat)

p_trade_1 <- data.frame(d = trade_svd$d[1:dmax]) %>%
  ggplot(aes(x = 1:dmax, y = d^2)) + 
  geom_point() +
  theme_bw() +
  xlab("Number of components" ) + 
  ylab(TeX(paste0("Top ", dmax, " squared singular values"))) +
  ggtitle("Trade network (total amount)") +
  my_theme

p_trade_1
```


```{r}
trade <- trade_raw[year %in% yr]

trade_g <- graph_from_data_frame(trade)
trade_mat <- sweep(trade_mat, 1, rowSums(trade_mat), "/")

trade_svd <- svd(trade_mat)

p_trade_2 <- data.frame(d = trade_svd$d[1:dmax]) %>%
  ggplot(aes(x = 1:dmax, y = d^2)) + 
  geom_point() +
  theme_bw() +
  xlab("Number of components" ) + 
  ylab(TeX(paste0("Top ", dmax, " squared singular values"))) +
  ggtitle("Trade network (proportion of exports)") +
  my_theme

p_trade_2
```


## Innovation 

The innovation network is an industry-level network of knowledge flow based on patent citations in the US. The industry is classified by the 3-digit code of the North American Industry Classification System (NAICS) and we cover 87 industries in 2013. Please refer to the Data Appendix of Zhu and Yang (2020) for a detailed description of the construction of the innovation network.

```{r}
inno_raw <- fread("../data_empirical_network/naics3_uspc_naics3_W_matrix.csv")
```


```{r}
inno <- inno_raw[year == yr]
inno <- inno[,3:6]
setnames(inno, c("naics_citing", "naics_cited"),
         c("from", "to"))

inno_g <- graph_from_data_frame(inno)
inno_mat <- as_adjacency_matrix(inno_g, attr = "PWQij")
# inno_mat <- sweep(inno_mat, 2, colSums(inno_mat), "/")

inno_svd <- svd(inno_mat)

p_inno <- data.frame(d = inno_svd$d[1:dmax]) %>%
  ggplot(aes(x = 1:dmax, y = d^2)) + 
  geom_point() +
  theme_bw() +
  xlab("Number of components" ) + 
  ylab(TeX(paste0("Top ", dmax, " squared singular values"))) +
  ggtitle("Innovation network") +
  my_theme

p_inno
```



## Production network

The production network is a network of the input-output flow at the industry level in the US. Particularly, the input-output flow from industry i to j is defined as the proportion of input from industry i among all the inputs of industry j. Same as the innovation network, we use the 3-digit NAICS code and cover 87 industries in 2013. Please refer to the Data Appendix of Zhu and Yang (2020) for a detailed description of the construction of the production network.

```{r}
io_raw <- readxl::read_excel("../data_empirical_network/IO_naics3_1997_2018_naics07.xlsx")
setDT(io_raw)
```

```{r}
io <- io_raw[year == yr]
setnames(io, c("naics3_seller", "naics3_buyer"),
         c("from", "to"))

io_g <- graph_from_data_frame(io)
io_mat <- as_adjacency_matrix(io_g, attr = "value")
io_mat <- sweep(io_mat, 2, colSums(io_mat), "/")

io_svd <- svd(io_mat)

p_prod <- data.frame(d = io_svd$d[1:dmax]) %>%
  ggplot(aes(x = 1:dmax, y = d^2)) + 
  geom_point() +
  theme_bw() +
  xlab("Number of components" ) + 
  ylab(TeX(paste0("Top ", dmax, " squared singular values"))) +
  ggtitle("Production network") +
  my_theme

p_prod

# ggsave(paste0("../output_RESTUD/production_network_y", yr, ".pdf"),
#        width = 12, height = 8)
```


## Equity network

The equity network is a network of firm-level investor-investee shareholding relationships in China, i.e., the percentage of shares of firm j owned by firm i. In 2013, we include 3.6 million firms that have at least one firm as their shareholders2 and we focus on the largest connected component3 which includes 1.3 million firms. Please refer to Cai et al. (2021) for a detailed description of the construction of the equity network.

The equity network data is proprietary but we provide the top 50 singular values.

```{r}
g_svd_df <- fread("../data_empirical_network/equity_network_svd.csv")
p_equity <- g_svd_df[1:dmax,] %>%
  ggplot(aes(x = 1:dmax, y = d^2)) + 
  geom_point() +
  theme_bw() +
  xlab("Number of components" ) + 
  ylab(TeX(paste0("Top ", dmax, " squared singular values"))) +
  ggtitle("Equity network") +
  my_theme

p_equity
```


# All together

The following chunk reproduces Figure S2.

```{r}
prow <- cowplot::plot_grid(p_trade, p_inno, p_prod, p_equity, 
           align = 'vh',
           labels = c("A", "B", "C", "D"),
           hjust = -2,
           nrow = 2
           )

prow

# ggsave(paste0("../output_/four_examples.pdf"), 
       # width = 12, height = 8)
```
